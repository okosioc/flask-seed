function install_form(){_install_form($(".form-editor"))}function process_form(i){var e={valid:!0},a=i.children("fieldset");return _process(e,a,a.attr("name")),debug(e),e}function _install_form(i){i.find(".act > .add").click(function(){var i=$(this).parent().prev(".list-group"),e=i.children(".list-group-item.template").clone(!0);e.removeClass("template"),i.append(e),_install_components(e)}),i.find(".act > .del").click(function(){return!!window.confirm("Are you sure to delete this item?")&&void $(this).closest(".list-group-item").remove()}),_install_components(i)}function _install_components(i){i.find(".form-group").each(function(i,e){var a=$(e);return!a.closest(".list-group-item").is(".template")&&(!a.closest("fieldset").is(".template")&&(a.find("img[data-src]").each(function(i,e){var a,l=$(e).closest(".plupload-input-group").children(".plupload");l&&(a=l.attr("data-preview")?JSON.parse(l.attr("data-preview")):{},$(e).attr("src",my_preview($(e).data("src"),a)))}),a.find(".custom-switch").each(function(i,e){var a="switch-"+my_random(),l=$(e).find(":checkbox");l.attr("id",a),l.next("label").attr("for",a)}),a.find("input.date-time").each(function(i,e){$(e).flatpickr({enableTime:!0,dateFormat:"Y-m-d H:i:S",defaultHour:(new Date).getHours(),defaultMinute:(new Date).getMinutes()})}),a.find("input.date").each(function(i,e){$(e).flatpickr({dateFormat:"Y-m-d"})}),a.find(".time-range-input-group").each(function(i,e){var a=$(e).find(".time-start").timepicker({timeFormat:"H:i"}),l=$(e).find(".time-end").timepicker({timeFormat:"H:i"});a.change(function(){var i=$(this).val();if(!my_validateHhMm(i))return!1;var e=i.split(":"),a=(parseInt(e[0])+1).toString().padStart(2,"0");l.val(a+":"+e[1])})}),a.find("select.select2").each(function(i,e){var a={containerCssClass:e.getAttribute("class").replace("select2",""),dropdownAutoWidth:!0,dropdownCssClass:e.classList.contains("custom-select-sm")||e.classList.contains("form-control-sm")?"dropdown-menu dropdown-menu-sm show":"dropdown-menu show",dropdownParent:e.closest(".modal-body")||document.body,tags:$(e).is("[tags]")};$(e).select2(a)}),a.find(".plupload").each(function(i,e){install_plupload($(e))}),void a.find(".quill").each(function(i,e){install_quill($(e))})))})}var global_pluploading=!1;function install_plupload(i){var l=i.closest(".plupload-input-group").find(".plupload-input-result"),t=i.is("[multiple]"),o=i.data("hiddens"),e=i.data("upload"),a=i.data("token"),d=i.data("max"),p=i.attr("data-preview")?JSON.parse(i.attr("data-preview")):{},u=i.attr("data-suffix")?JSON.parse(i.attr("data-suffix")):{},s=i.attr("data-filters")?JSON.parse(i.attr("data-filters")):{},c=l.is(".image-input-result");i.attr("id","plupload-"+my_random());var n=new plupload.Uploader({browse_button:i[0],url:e,max_file_size:d,filters:s,multi_selection:t,multipart_params:{token:a}});n.init(),n.bind("FilesAdded",function(i,e){var a="";plupload.each(e,function(i){a+=c?'<div id="'+i.id+'" class="image uploading"><div class="progress progress-sm"><div class="progress-bar" style="width:5%;"></div></div></div>':'<div id="'+i.id+'" class="file uploading d-flex justify-content-start align-items-center"><div class="mr-3">'+i.name+'</div><div class="flex-grow-1 mr-3"><div class="progress progress-sm"><div class="progress-bar" style="width:5%;"></div></div></div></div>'}),t?l.append(a):l.html(a),i.start(),global_pluploading=!0}),n.bind("UploadProgress",function(i,e){$("#"+e.id).find(".progress-bar").css("width",e.percent+"%")}),n.bind("Error",function(i,e){var a;e.file&&$("#"+e.file.id).length?(a='<small class="text-danger">'+e.file.name+(c?"<br>":"")+e.message+" ("+e.code+")</small>",$("#"+e.file.id).removeClass("uploading").addClass("error").html(a)):showError("Failed when uploading, "+e.message+" ("+e.code+")")}),n.bind("FileUploaded",function(i,e,a){var l,t,d,s,n,r=jQuery.parseJSON(a.response);r.error?(l='<small class="text-danger">'+e.name+(c?"<br>":"")+r.error+"</small>",$("#"+e.id).removeClass("uploading").addClass("error").html(l)):((t=$("#"+e.id)).removeClass("uploading").addClass("uploaded"),n=c?(d=my_preview(r.url,p),s=$("<img>").one("load",function(){$(this).closest(".image").css("width","auto")}).attr("src",d),t.html(s),'<div class="btns"><a href="'+r.url+'" target="_blank">i</a><a href="javascript:;" onclick="$(this).closest(\'.image\').remove();">x</a></div>'):(t.find(".flex-grow-1").remove(),'<div><a class="mr-2" href="'+r.url+'" target="_blank">i</a><a href="javascript:;" onclick="$(this).closest(\'.file\').remove();">x</a></div>'),t.append(n),$.each(o.split(","),function(i,e){var a=e in r?r[e]:"";"url"==e&&(a=my_preview(a,u));var l=$('<input type="hidden" name="'+e+'">').val(a);t.append(l)}))}),n.bind("UploadComplete",function(i,e){global_pluploading=!1})}function install_quill(i){var e=my_random(),a=i.data("upload"),l=i.data("token"),t=i.data("max"),d=i.attr("data-preview")?JSON.parse(i.attr("data-preview")):{},s=i.attr("data-filters")?JSON.parse(i.attr("data-filters")):{};i.attr("id","quill-"+e);var n=new Quill(i[0],{placeholder:"Please input rich text here",theme:"snow",modules:{toolbar:{container:[[{header:[2,!1]}],["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}],["link","image"],["blockquote","code-block"],["clean"]],handlers:{image:function(i){i?$("#quill-plupload-"+e).next(".moxie-shim").children("input[type=file]").trigger("click"):this.quill.format("image",!1)}}}}}),r=i.closest(".rte-input-group").find(".quill-plupload");r.attr("id","quill-plupload-"+e);var o=new plupload.Uploader({browse_button:r[0],url:a,max_file_size:t,filters:s,multi_selection:!0,multipart_params:{token:l}});o.init(),o.bind("FilesAdded",function(i,e){i.start(),global_pluploading=!0}),o.bind("Error",function(i,e){e.file?showError("Failed when uploading file "+e.file.name+", "+e.message+" ("+e.code+")"):showError("Failed when uploading, "+e.message+" ("+e.code+")")}),o.bind("FileUploaded",function(i,e,a){var l,t=jQuery.parseJSON(a.response);t.error?showError("Failed when uploading file "+e.name+", "+t.error):(l=(n.getSelection()||{}).index||n.getLength(),n.insertEmbed(l,"image",my_preview(t.url,d)),n.insertText(l+1,"\n"),n.setSelection(l+2))}),o.bind("UploadComplete",function(i,e){global_pluploading=!1})}function _process(l,i,t){var e,a,d,s,n,r,o,p,u,c,m,v,f,g,h,_,b,w;debug("Try to process path "+t),i.is(".object")?i.find("> .form-group, > .form-row .form-group, > fieldset").each(function(i,e){var a=$(e).attr("name");a&&(a.includes(".")?_process(l,$(e),a):_process(l,$(e),t+"."+a))}):i.is(".array")?(e=i.find("select"),n=i.find(".plupload-input-group"),e.length?(e.removeClass("is-valid is-invalid"),(a=e.val()).length?$.each(a,function(i,e){l[t+"["+i+"]"]=e}):e.is("[required]")&&(e.addClass("is-invalid"),l.valid=!1),debug("Parsed array's length is "+a.length)):n.length?(n.removeClass("is-valid is-invalid"),(d=n.find(".uploaded")).length?$.each(d,function(a,i){var e=$(i).find(":hidden[name]");1==e.length?l[t+"["+a+"]"]=e.val():$.each(e,function(i,e){l[t+"["+a+"]."+$(e).attr("name")]=$(e).val()})}):n.is("[required]")&&(n.addClass("is-invalid"),l.valid=!1),debug("Parsed array's length is "+d.length)):i.find("> .list-group > .list-group-item").not(".template").each(function(i,e){_process(l,$(e).children(),t+"["+i+"]")})):(s=i.find(".radio-input-group"),n=i.find(".plupload-input-group"),r=i.find(".rte-input-group"),o=i.find(".time-range-input-group"),p=i.find(".input-group"),u=i.find(":input[name]"),s.length?(s.removeClass("is-valid is-invalid"),(c=s.find(".active")).length?l[t]=c.children(":radio").val().trim():s.is("[required]")&&(s.addClass("is-invalid"),l.valid=!1)):n.length?(n.removeClass("in-valid is-invalid"),(m=n.find(".uploaded")).length?l[t]=m.find(":hidden[name=url]").val():n.is("[required]")&&(n.addClass("is-invalid"),l.valid=!1)):r.length?(r.removeClass("in-valid is-invalid"),v=r.find(".ql-editor").html().trim(),r.find(".ql-editor").text().trim().length?l[t]=v:r.is("[required]")&&(r.addClass("is-invalid"),l.valid=!1)):o.length?(g=(f=o.find("input.time-start")).val().trim(),_=(h=o.find("input.time-end")).val().trim(),o.removeClass("in-valid is-invalid"),f.removeClass("in-valid is-invalid"),h.removeClass("in-valid is-invalid"),g.length||_.length?(l[t.replace("@",f.attr("name"))]=g,l[t.replace("@",h.attr("name"))]=_,l[t]=g+"~"+_,!my_validateHhMm(g)||!my_validateHhMm(_)||_<=g?(o.addClass("is-invalid"),f.addClass("is-invalid"),h.addClass("is-invalid"),l.valid=!1):(o.addClass("is-valid"),f.addClass("is-valid"),h.addClass("is-valid"))):o.is("[required]")&&(o.addClass("is-invalid"),f.addClass("is-invalid"),h.addClass("is-invalid"),l.valid=!1)):p.length?(b=p.find(":input[name]"),p.removeClass("is-invalid is-valid"),w=b.val().trim(),b.is(":checkbox")&&(w=b.is(":checked")?"true":"false"),w.length?(l[t]=w,b[0].checkValidity&&(!1===b[0].checkValidity()?(p.addClass("is-invalid"),b.addClass("is-invalid"),l.valid=!1):(p.addClass("is-valid"),b.addClass("is-valid")))):p.is("[required]")&&(p.addClass("is-invalid"),b.addClass("is-invalid"),l.valid=!1)):u.length&&(u.removeClass("is-invalid is-valid"),w=u.val().trim(),u.is(":checkbox")&&(w=u.is(":checked")?"true":"false"),w.length?(l[t]=w,u[0].checkValidity&&(!1===u[0].checkValidity()?(u.addClass("is-invalid"),l.valid=!1):u.addClass("is-valid"))):u.is("[required]")&&(u.addClass("is-invalid"),l.valid=!1)),debug("Parsed string is "+l[t]),t.includes("@")&&delete l[t])}function debug(i,e){console&&console.log&&(e?console.log(i,e):console.log(i))}function my_preview(i,e){var a=i.split(/[#?]/)[0],l=a.split(".").pop().trim().toLowerCase();return("mov"==l||"mp4"==l||"mpeg"==l||"webm"==l)&&"video"in e?a+e.video:"image"in e?a+e.image:i}function my_random(){return Math.floor(1e9*Math.random())}function my_validateHhMm(i){return/^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(i)}
function install_form(){_install_form($(".form-editor"))}function process_form(i){var e={valid:!0},l=i.children("fieldset");return _process(e,l,l.attr("name")),debug(e),e}function _install_form(i){i.find(".act > .add").click(function(){var i=$(this).parent().prev(".list-group"),e=i.children(".list-group-item.template").clone(!0);e.removeClass("template"),i.append(e),_install_components(e)}),i.find(".act > .del").click(function(){return!!window.confirm("Are you sure to delete this item?")&&void $(this).closest(".list-group-item").remove()}),_install_components(i)}function _install_components(i){i.find("input.date-time:visible").each(function(i,e){$(e).flatpickr({enableTime:!0,dateFormat:"Y-m-d H:i:S",defaultHour:(new Date).getHours(),defaultMinute:(new Date).getMinutes()})}),i.find("input.date:visible").each(function(i,e){$(e).flatpickr({dateFormat:"Y-m-d"})}),i.find("select.select2:visible").each(function(i,e){var l={tags:$(e).is("[tags]")};$(e).select2(l)}),i.find(".plupload:visible").each(function(i,e){install_plupload($(e))}),i.find(".quill:visible").each(function(i,e){install_quill($(e))})}var global_pluploading=!1;function install_plupload(i){var a=i.closest(".image-input-group").find(".image-input-result"),n=i.is("[multiple]"),r=i.data("hiddens"),e=i.data("upload"),l=i.data("token"),t=i.data("max"),o=i.data("preview"),d=i.data("filters");i.attr("id","plupload-"+Math.round(new Date/1e3));var s=new plupload.Uploader({browse_button:i[0],url:e,max_file_size:t,filters:d,multi_selection:n,multipart_params:{token:l}});s.init(),s.bind("FilesAdded",function(i,e){var l="";plupload.each(e,function(i){l+='<div id="'+i.id+'" class="image uploading"><div class="progress progress-sm"><div class="progress-bar" style="width:5%;"></div></div></div>'}),n?a.append(l):a.html(l),i.start(),global_pluploading=!0}),s.bind("UploadProgress",function(i,e){$("#"+e.id).find(".progress-bar").css("width",e.percent+"%")}),s.bind("Error",function(i,e){var l;e.file?(l='<small class="text-danger">'+e.file.name+"<br>"+e.message+" ("+e.code+")</small>",$("#"+e.file.id).length?$("#"+e.file.id).removeClass("uploading").addClass("error").html(l):(l='<div id="'+e.file.id+'" class="image error">'+l+"</div>",a.html(l))):showError("Failed when uploading, "+e.message+" ("+e.code+")")}),s.bind("FileUploaded",function(i,e,l){var a,n,t,d,s=jQuery.parseJSON(l.response);s.error?(a='<small class="text-danger">'+e.name+"<br>"+s.error+"</small>",$("#"+e.id).removeClass("uploading").addClass("error").html(a)):(n=$("<img>").one("load",function(){$(this).closest(".image").css("width","auto")}).attr("src",s.url+o),t=$("#"+e.id).removeClass("uploading").addClass("uploaded").html(n),d='<div class="btns"><a href="'+s.url+'" target="_blank">i</a><a href="javascript:;" onclick="$(this).closest(\'.image\').remove();">x</a></div>',t.append(d),$.each(r.split(","),function(i,e){var l=e in s?s[e]:"",a=$('<input type="hidden" name="'+e+'">').val(l);t.append(a)}))}),s.bind("UploadComplete",function(i,e){global_pluploading=!1})}function install_quill(i){var e=Math.round(new Date/1e3),l=i.data("upload"),a=i.data("token"),n=i.data("max"),t=i.data("preview"),d=i.data("filters");i.attr("id","quill-"+e);var s=new Quill(i[0],{placeholder:"Please input rich text here",theme:"snow",modules:{toolbar:{container:[[{header:[2,!1]}],["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}],["link","image"],["blockquote","code-block"],["clean"]],handlers:{image:function(i){i?$("#quill-plupload-"+e).next(".moxie-shim").children("input[type=file]").trigger("click"):this.quill.format("image",!1)}}}}}),r=i.closest(".rte-input-group").find(".quill-plupload");r.attr("id","quill-plupload-"+e);var o=new plupload.Uploader({browse_button:r[0],url:l,max_file_size:n,filters:d,multi_selection:!0,multipart_params:{token:a}});o.init(),o.bind("FilesAdded",function(i,e){i.start(),global_pluploading=!0}),o.bind("Error",function(i,e){e.file?showError("Failed when uploading file "+e.file.name+", "+e.message+" ("+e.code+")"):showError("Failed when uploading, "+e.message+" ("+e.code+")")}),o.bind("FileUploaded",function(i,e,l){var a,n=jQuery.parseJSON(l.response);n.error?showError("Failed when uploading file "+e.name+", "+n.error):(a=(s.getSelection()||{}).index||s.getLength(),s.insertEmbed(a,"image",n.url+t),s.insertText(a+1,"\n"),s.setSelection(a+2))}),o.bind("UploadComplete",function(i,e){global_pluploading=!1})}function _process(a,i,n){var e,l,t,d,s,r,o,u,c,p,m;debug("Try to process path "+n),i.is(".object")?i.find("> .form-group, > fieldset").each(function(i,e){_process(a,$(e),n+"."+$(e).attr("name"))}):i.is(".array")?(e=i.children("select"),s=i.children(".image-input-group"),e.length?(e.removeClass("is-valid is-invalid"),(l=e.val()).length?$.each(l,function(i,e){a[n+"["+i+"]"]=e}):e.is("[required]")&&(e.addClass("is-invalid"),a.valid=!1),debug("Parsed array's length is "+l.length)):s.length?(s.removeClass("in-valid is-invalid"),(t=s.find(".image.uploaded")).length?$.each(t,function(l,i){var e=$(i).find(":hidden[name]");1==e.length?a[n+"["+l+"]"]=e.val():$.each(e,function(i,e){a[n+"["+l+"]."+$(e).attr("name")]=$(e).val()})}):s.is("[required]")&&(s.addClass("is-invalid"),a.valid=!1),debug("Parsed array's length is "+t.length)):i.find("> .list-group > .list-group-item").not(".template").each(function(i,e){_process(a,$(e).children(),n+"["+i+"]")})):(d=i.children(".radio-input-group"),s=i.children(".image-input-group"),r=i.children(".rte-input-group"),o=i.children(":input[name]"),d.length?(d.removeClass("is-valid is-invalid"),(u=d.find(".active")).length?a[n]=u.children(":radio").val().trim():d.is("[required]")&&(d.addClass("is-invalid"),a.valid=!1)):s.length?(s.removeClass("in-valid is-invalid"),(c=s.find(".image.uploaded")).length?a[n]=c.find(":hidden[name=url]").val():s.is("[required]")&&(s.addClass("is-invalid"),a.valid=!1)):r.length?(r.removeClass("in-valid is-invalid"),p=r.find(".ql-editor").html().trim(),r.find(".ql-editor").text().trim().length?a[n]=p:r.is("[required]")&&(r.addClass("is-invalid"),a.valid=!1)):o.length&&(o.removeClass("is-invalid is-valid"),(m=o.val().trim()).length?(a[n]=m,o[0].checkValidity&&(!1===o[0].checkValidity()?(o.addClass("is-invalid"),a.valid=!1):o.addClass("is-valid"))):o.is("[required]")&&(o.addClass("is-invalid"),a.valid=!1)),debug("Parsed string is "+a[n]))}function debug(i,e){console&&console.log&&(e?console.log(i,e):console.log(i))}